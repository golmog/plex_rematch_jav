# Plex JAV Rematch (plex_rematch_jav.py)

## 주요 기능

-   **자동 재매칭**: 지정된 라이브러리에서 메타데이터가 불완전한 항목들을 찾아 파일명 기반으로 자동 재매칭을 시도합니다.
-   **인터랙티브 모드**:
    -   **품번 수정 (`--fix-labels`)**: 파일명과 Plex 제목의 품번이 일치하지 않거나, 미매칭된 항목들을 찾아 목록을 보여주고, 사용자가 직접 올바른 메타데이터를 선택하여 수정할 수 있습니다.
    -   **포스터 없는 항목 처리 (`--no-poster`)**: 포스터가 없거나 임시 썸네일로 지정된 항목들을 찾아 재매칭을 유도합니다.
    -   **검색 및 재매칭 (`--search`)**: 특정 키워드로 라이브러리를 검색하여 나온 결과를 대상으로 재매칭을 진행합니다.
    -   **미매칭 파일 이동 (`--move-no-meta`)**: 매칭되지 않은 미디어 파일을 설정된 경로로 이동시키고 라이브러리에서 제거하여 라이브러리를 정리합니다.
-   **Plex Dance 자동화**: 메타데이터가 심하게 꼬인 항목에 대해 라이브러리에서 아이템을 완전히 제거했다가 다시 추가하는 "Plex Dance" 과정을 자동화하여 문제를 해결합니다.
-   **라이브러리 스캔**:
    -   **분할 스캔 (`--scan-full`)**: 대용량 라이브러리 스캔 시 Plex 서버에 과부하가 걸리는 것을 방지하기 위해, 라이브러리 경로를 지정된 깊이(depth)의 하위 폴더 단위로 나누어 순차적으로 스캔합니다.
    -   **상세한 스캔 상태 로깅**: 스캔 진행률 뿐만 아니라 현재 처리 중인 활동 종류와 상세 정보를 로그에 표시하여 멈춤 현상인지 정상 처리 중인지 명확히 알 수 있습니다.
-   **설정 파일 지원**: `YAML` 형식의 설정 파일을 통해 Plex 서버 정보, 작업 옵션 등을 쉽게 관리할 수 있습니다.
-   **Dry Run 지원**: `--dry-run` 옵션을 통해 실제 변경 없이 어떤 작업이 수행될지 미리 확인할 수 있습니다.

---

## 업데이트

**2025-09-20**

-   **신규 기능**:
    - `--update-actors` 옵션 추가 (외부 배우 DB와 비교하여 오래된 정보 업데이트)
    - `--find-dupes` 옵션 추가 (섹션 내에 동일 품번이 중복 등록되어 있는 항목 검색)
-   **기능 개선**: 인터랙티브 모드(`--fix-labels`, `--search` 등)에서 **Plex Dance** 기능 강화)
    -   단순 DB 제거가 아닌, 파일 시스템 이동, 번들/캐시 청소, 휴지통 비우기를 포함하여 잘못된 썸네일 등 모든 잔여 데이터를 확실하게 제거.
    -   다중 파트 파일(CD1, CD2)도 안전하게 처리.
    -   서버의 "미디어 삭제 허용" 설정과 무관하게 동작하여 파일 삭제 위험 제거.
-   **기능 개선**: `--force-complete` 옵션을 ID 입력 방식에서 사용자 친화적인 인터랙티브 목록 선택 방식으로 변경.
-   **기능 개선**: 모든 인터랙티브 모드에서 작업 후 목록이 자동으로 갱신되어, 변경된 ID로 인한 오류 방지.
-   **기능 개선**: GUID prefix/site map을 yaml에서 설정할 수 있도록 변경
-   **품번 추출 로직 강화**: YAML로 제공된 정교한 특수/범용 규칙 기반의 새로운 품번 파서(`JAV_PARSING_RULES`)를 도입하여 정확성 대폭 향상.
-   **버그 수정**: 재매칭 후 업데이트 확인 로직, 품번 비교 로직 등 다수 버그 수정 및 안정성 강화.

**2025-09-09**

-   `--force-complete` 옵션 추가: DB(스크립트)에서 특정 항목을 완료된 것으로 강제 처리
-   JAV_PARSING_RULES 추가(yaml): 품번 추출 패턴 설정(특수/일반)
-   품번 비교 로직 버그 수정: 다른 품번이 '품번 일치'로 표시되는 문제
-   매칭 후 리프레시 로직 개선: 재시도, 확인 로직 강화
-   수동 매칭시 직접 검색어를 입력할 수 있는 기능 추가


**2025-08-11**

-   `--move-no-meta` 옵션 추가: 미매칭 파일 이동 및 라이브러리 정리 기능
-   `--scan-at-once` 옵션 추가: 대기 없는 즉시 스캔 요청 기능
-   라이브러리 스캔 시, 진행률 외에 현재 활동 종류와 파일 경로를 상세히 로깅하도록 개선

Plex에 등록된 JAV 라이브러리의 메타데이터를 효율적으로 수정하고 재매칭하기 위한 파이썬 스크립트입니다. 파일명을 기반으로 정확한 품번을 추출하여 Plex의 검색 기능을 통해 올바른 메타데이터를 찾고, 잘못 매칭되었거나 정보가 부족한 항목들을 자동으로 또는 인터랙티브하게 수정합니다.


## 요구사항

-   Python 3.8 이상 (권장 3.9 이상)
-   라이브러리: `requests`, `psutil`, `PyYAML`, `plexapi`

## 설치

1.  **스크립트 다운로드**:
    `plex_rematch_jav.py` 파일을 다운로드하거나 Git을 통해 저장소를 복제합니다.

    ```bash
    git clone [저장소 URL]
    cd [저장소 디렉터리]
    ```

2.  **필요한 라이브러리 설치**:

    ```bash
    pip install requests psutil pyyaml plexapi
    ```

## 설정

스크립트를 처음 실행하기 전에 설정 파일을 준비해야 합니다.

1.  **설정 파일 생성**:
    함께 제공되는 `plex_rematch_jav_sample.yaml` 파일을 `plex_rematch_jav.yaml`으로 복사하여 스크립트와 같은 디렉터리에 둡니다.

2.  **필수 항목 수정**:
    `plex_rematch_jav.yaml` 파일을 열어 아래 필수 항목들을 사용자의 환경에 맞게 수정하세요.
    -   `PLEX_URL`: 사용자의 Plex 서버 주소로 변경하세요.
    -   `PLEX_TOKEN`: [Finding your Plex authentication token](https://support.plex.tv/articles/204059436-finding-an-authentication-token-x-plex-token/)을 참고하여 Plex 토큰을 찾아 입력하세요.
    -   `PLEX_DB`: 사용자의 Plex 데이터베이스 파일 경로를 정확하게 입력하세요. 경로는 운영체제 및 설치 방식에 따라 다릅니다.
    -   `MOVE_NO_META_PATH`: `--move-no-meta` 옵션 사용 시, 파일을 이동시킬 경로를 지정합니다. 이 기능을 사용하지 않을 경우 비워두거나 주석 처리합니다.

## 사용법

모든 명령어는 터미널에서 실행합니다.

### 1. 라이브러리 ID 확인

작업을 수행할 라이브러리의 섹션 ID를 먼저 확인해야 합니다.

```bash
python3 plex_rematch_jav.py --check-id
```

### 2. 자동 재매칭

지정한 라이브러리에서 조건에 맞는 아이템들을 자동으로 재매칭합니다. (가장 기본적인 사용법)

```bash
# 섹션 ID 2번 라이브러리에 대해 자동 재매칭 실행
python3 plex_rematch_jav.py --section-id 2
```

### 3. 인터랙티브 모드


#### 품번 수정 (`--fix-labels`)

```bash
python3 plex_rematch_jav.py --section-id 2 --fix-labels
```

#### 포스터 없는 항목 처리 (`--no-poster`)

```bash
python3 plex_rematch_jav.py --section-id 2 --no-poster
```

#### 검색 후 재매칭 (`--search`)

```bash
python3 plex_rematch_jav.py --section-id 2 --search "ABCD-123"
```

-   `--search-field`: 검색할 필드를 `title`(기본값), `label`, `site` 중에서 선택할 수 있습니다.

#### 미매칭 파일 이동 (`--move-no-meta`)

```bash
python3 plex_rematch_jav.py --section-id 2 --move-no-meta
```

#### 배우 정보 업데이트 (`--update-actors`)

```bash
python3 plex_rematch_jav.py --section-id 2 --update-actors
```

#### 수동 완료 처리 (`--force-complete`)

```bash
python3 plex_rematch_jav.py --section-id 2 --force-complete
```

#### 중복 품번 검색 (`--find-dupes`)

```bash
python3 plex_rematch_jav.py --section-id 2 --find-dupes
```

### 4. 라이브러리 스캔

#### 분할 스캔 (`--scan-full`)

라이브러리 섹션 전체 경로를 설정된 `SCAN_DEPTH` 기준으로 나누어 순차적으로 스캔합니다.

```bash
python3 plex_rematch_jav.py --section-id 2 --scan-full
```

#### 특정 경로 스캔 (`--scan-path`)

지정한 특정 폴더만 스캔합니다.

```bash
# 기본 동작: Plex 유휴 상태 확인 후, 스캔이 완료될 때까지 대기
python3 plex_rematch_jav.py --section-id 2 --scan-path "/mnt/media/new_folder"

# 즉시 요청: Plex 상태와 관계없이 스캔 요청 후 바로 종료
python3 plex_rematch_jav.py --section-id 2 --scan-path "/mnt/media/new_folder" --scan-no-wait
```

### 5. 전체 옵션 목록

아래 옵션들은 모든 모드 또는 특정 모드에서 동작을 세밀하게 제어할 때 사용합니다. `YAML` 설정 파일 또는 명령줄 인자로 지정할 수 있으며, 명령줄 인자가 우선 적용됩니다.

#### 주요 작업 모드
-   `--fix-labels`: 품번 불일치/미매칭 아이템을 찾아 수정하는 인터랙티브 모드를 실행합니다.
-   `--no-poster`: 포스터가 없거나 비정상적인 아이템을 찾아 수정하는 인터랙랙티브 모드를 실행합니다.
-   `--move-no-meta`: 미매칭 아이템을 지정된 경로로 이동하는 인터랙티브 모드를 실행합니다.
-   `--search <키워드>`: 키워드로 아이템을 검색하여 재매칭하는 인터랙티브 모드를 실행합니다.
-   `--scan-full`: 라이브러리 섹션의 전체 경로를 분할 스캔합니다.
-   `--scan-path <경로>`: 지정된 경로만 스캔합니다.
-   `--force-complete`: 수동으로 작업한 항목을 '완료' 처리하는 모드

#### 작업 대상 필터링
-   `--include <키워드>`: 제목/정렬제목에 `<키워드>`가 포함된 아이템만 작업 대상으로 합니다. (여러 번 사용 가능)
-   `--exclude <키워드>`: 제목/정렬제목에 `<키워드>`가 포함된 아이템을 작업 대상에서 제외합니다. (여러 번 사용 가능)

#### 동작 방식 제어
-   `--dry-run`: 실제 변경 작업을 수행하지 않고 로그만 출력하여 테스트합니다.
-   `--force-rematch`: 매칭 상태와 관계없이 강제로 언매치 후 재매칭을 시도합니다.
-   `--include-completed`: 완료 DB에 기록된 아이템도 다시 작업 대상에 포함합니다.
-   `--match-limit <숫자>`: 처리할 최대 아이템 수를 제한합니다. (0이면 무제한)
-   `--match-interval <초>`: 각 아이템 처리 후 다음 아이템 처리까지 대기할 시간을 초 단위로 지정합니다.

#### 매칭 로직 제어
-   `--score-min <점수>`: 재매칭 시 후보로 인정할 최소 점수(0-100)를 지정합니다.
-   `--manual-search`: Plex '일치항목 검색' 시 수동 모드(manual=1)로 더 많은 후보를 가져옵니다.
-   `--numeric-padding-length <길이>`: 품번의 숫자 부분을 0으로 채울 때 목표 길이를 지정합니다.

#### 스캔 세부 설정
-   `--scan-depth <깊이>`: `--scan-full` 사용 시, 하위 폴더를 스캔할 기준 깊이를 지정합니다.

#### 경로 및 연결 설정
-   `--plex-db <경로>`: Plex 데이터베이스 파일의 절대 경로를 지정합니다.
-   `--plex-url <주소>`: Plex 서버의 URL을 지정합니다.
-   `--plex-token <토큰>`: Plex 인증 토큰을 지정합니다.
-   `--completion-db <경로>`: 완료된 작업 목록을 기록할 데이터베이스 파일 경로를 지정합니다.

#### 성능 및 네트워크
-   `--workers <숫자>`: 자동 재매칭 시 동시에 실행할 작업자(스레드) 수를 지정합니다.
-   `--check-count <횟수>`: 재매칭 후 메타데이터 업데이트 반영을 확인하는 최대 횟수를 지정합니다.
-   `--check-interval <초>`: 메타데이터 업데이트 확인 사이의 대기 시간을 초 단위로 지정합니다.
-   `--timeout-get <초>`: API GET 요청의 타임아웃 시간을 초 단위로 지정합니다.
-   `--timeout-put <초>`: API PUT 요청의 타임아웃 시간을 초 단위로 지정합니다.

#### 설정 파일 및 로깅
-   `--config <파일경로>`: 기본 `plex_rematch_jav.yaml` 외에 다른 설정 파일을 사용합니다.
-   `-v`, `-vv`: 로그 출력 수준을 높입니다. 일반 정보는 `-v`, 상세 디버깅 정보는 `-vv`를 사용합니다.
-   `--workers`, `--match-limit`, `--match-interval`, `--score-min` 등 다양한 세부 옵션 제공 (자세한 내용은 `--help` 참조)

## 기여

버그를 발견하거나 새로운 기능을 제안하고 싶다면 언제든지 GitHub 이슈를 열어주세요. Pull Request도 환영합니다.

## 면책 조항

이 스크립트는 Plex 데이터베이스와 상호작용하며 파일을 이동시킬 수 있습니다. 사용하기 전에 **반드시 Plex 데이터베이스 파일을 백업**하세요. 스크립트 사용으로 인해 발생하는 데이터 손실이나 문제에 대해 제작자는 책임을 지지 않습니다. `--dry-run` 옵션을 통해 충분히 테스트한 후 사용하시기 바랍니다.
